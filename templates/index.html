<html>

<head>
  <title>Demo</title>
</head>

<body>
  <div id="plot">
  </div>
  <div id="app">
    selected users: [[ selectedUser.length ]]
    <ul>
      <li v-for="[x, y, label, id] in selectedUser" :key="id">[[ id ]]</li>
    </ul>
  </div>
</body>

<!-- import Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
<!-- import d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script>
  const plot = {{ plot|tojson }}

  var app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
      selectedUser: [],
    },

    mounted() {
      this.draw()
    },

    methods: {
      draw() {
        const vue = this
        const data = plot
        const [minX, maxX] = data.reduce((a, b) => [Math.min(a[0], b[0]), Math.max(a[1], b[0])], [Infinity, -Infinity])
        const [minY, maxY] = data.reduce((a, b) => [Math.min(a[0], b[1]), Math.max(a[1], b[1])], [Infinity, -Infinity])
        const margin = { top: 20, right: 20, bottom: 20, left: 20 }
        const fullWidth = 1200
        const width = fullWidth - margin.left - margin.right
        const fullHeight = 700
        const height = fullHeight - margin.top - margin.bottom

        const x = d3.scaleLinear()
          .domain([minX, maxX])
          .range([0, width])
        const y = d3.scaleLinear()
          .domain([minY, maxY])
          .range([height, 0])
        const color = d3.scaleOrdinal()
          .domain(["midnight", "morning", "afternoon", "evening"])
          .range(["#003f5c", "#7a5195", "#ef5675", "#ffa600"])

        const svg = d3.select("#plot")
          .append("svg")
          .attr("width", fullWidth)
          .attr("height", fullHeight)
          .style("border", "1px solid #000")
          .append("g")
          .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")")

        // Add dots
        const dots = svg.append('g')
          .selectAll("dot")
          .data(data)
          .enter()
          .append("circle")
          .attr("cx", d => x(d[0]))
          .attr("cy", d => y(d[1]))
          .attr("r", 7)
          .style("fill", d => color(d[2]))
          .style("opacity", 0.5)

        // Add brushing
        d3.select("#plot > svg")
          .call(
            d3.brush()
              .extent([[0, 0], [fullWidth, fullHeight]])
              .on("start brush", updateChart)
          )

        // Function that is triggered when brushing is performed
        function updateChart() {
          extent = d3.event.selection
          const selected = dots.filter(d => isBrushed(extent, x(d[0]), y(d[1])))
          dots.classed("selected", false)
          selected.classed("selected", true)
          vue.selectedUser = selected.nodes().map(node => node.__data__)
        }

        // A function that return TRUE or FALSE according if a dot is in the selection or not
        function isBrushed(brush_coords, cx, cy) {
          const x0 = brush_coords[0][0] - margin.left,
                x1 = brush_coords[1][0] - margin.left,
                y0 = brush_coords[0][1] - margin.top,
                y1 = brush_coords[1][1] - margin.top;
          return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;    // This return TRUE or FALSE depending on if the points is in the selected area
        }

        // Add legend
        const legendX = 1080, legendY = 30
        const labels = ['midnight', 'morning', 'afternoon', 'evening']
        labels.forEach((l, idx) => {
          svg.append("circle")
            .attr("cx", legendX)
            .attr("cy", 10 + legendY * idx)
            .attr("r", 7)
            .style("fill", color(l))
          svg.append("text")
            .attr("x", legendX + 20)
            .attr("y", 10 + legendY * idx)
            .text(l)
            .style("fill", "black")
            .style("font-size", "15px")
            .attr("alignment-baseline","middle")
        });
      },
    },
  });
</script>
<style>
.selected {
  opacity: 1 !important;
  stroke: black;
  stroke-width: 1px;
}
</style>

</html>