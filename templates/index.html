<html>

<head>
  <title>Demo</title>
</head>

<body>
  <div id="app">
    <!-- [[ plot ]] -->
  </div>
</body>

<!-- import Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
<!-- import d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>
<script>
  const plot = {{ plot| tojson }}

  var app = new Vue({
    el: '#app',
    delimiters: ['[[', ']]'],
    data: {
      plot,
      selectedUser: [],
    },

    mounted() {
      this.draw()
    },

    methods: {
      draw() {
        const vue = this
        const data = this.plot
        const [minX, maxX] = data.reduce((a, b) => [Math.min(a[0], b[0]), Math.max(a[1], b[0])], [Infinity, -Infinity])
        const [minY, maxY] = data.reduce((a, b) => [Math.min(a[0], b[1]), Math.max(a[1], b[1])], [Infinity, -Infinity])
        const margin = 20
        const width = 1200 - margin * 2
        const height = 700 - margin * 2
        var x = d3.scaleLinear()
          .domain([minX, maxX])
          .range([0, width])
        var y = d3.scaleLinear()
          .domain([minY, maxY])
          .range([height, 0])
        var color = d3.scaleOrdinal()
          .domain(["midnight", "morning", "afternoon", "evening"])
          .range(["#003f5c", "#7a5195", "#ef5675", "#ffa600"])

        const svg = d3.select("#app")
          .append("svg")
          .attr("width", width + margin * 2)
          .attr("height", height + margin * 2)
          .style("border", "1px solid #000")
          .append("g")
          .attr("transform",
            "translate(" + margin + "," + margin + ")")

        // Add dots
        const dots = svg.append('g')
          .selectAll("dot")
          .data(data)
          .enter()
          .append("circle")
          .attr("cx", d => x(d[0]))
          .attr("cy", d => y(d[1]))
          .attr("r", 7)
          .style("fill", d => color(d[2]))
          .style("opacity", 0.5)

        // Add brushing
        svg
          .call(
            d3.brush()
              .extent([[0, 0], [width, height]])
              .on("start brush", updateChart)
          )

        // Function that is triggered when brushing is performed
        function updateChart() {
          extent = d3.event.selection
          dots.classed("selected", d => isBrushed(extent, x(d[0]), y(d[1])))
        }

        // A function that return TRUE or FALSE according if a dot is in the selection or not
        function isBrushed(brush_coords, cx, cy) {
          var x0 = brush_coords[0][0],
            x1 = brush_coords[1][0],
            y0 = brush_coords[0][1],
            y1 = brush_coords[1][1];
          return x0 <= cx && cx <= x1 && y0 <= cy && cy <= y1;    // This return TRUE or FALSE depending on if the points is in the selected area
        }

        // Add legend
        const legendX = 1050, legendY = 30
        const labels = ['midnight', 'morning', 'afternoon', 'evening']
        labels.forEach((l, idx) => {
          svg.append("circle")
            .attr("cx", legendX)
            .attr("cy", 10 + legendY * idx)
            .attr("r", 7)
            .style("fill", color(l))
          svg.append("text")
            .attr("x", legendX + 30)
            .attr("y", 10 + legendY * idx)
            .text(l)
            .style("fill", "black")
            .style("font-size", "15px")
            .attr("alignment-baseline","middle")
        });
      },
    },
  });
</script>
<style>
.selected {
  opacity: 1 !important;
  stroke: black;
  stroke-width: 1px;
}
</style>

</html>